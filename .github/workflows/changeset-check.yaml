name: Changeset PR check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify .changeset exists for code changes
        run: |
          set -e
          git fetch origin main:refs/remotes/origin/main || true
          CHANGED=$(git diff --name-only origin/main...HEAD)
          # ignore trivial docs-only changes when enforcing changeset
          FILTERED=$(echo "$CHANGED" | grep -v '^.changeset/' | grep -vE '(^README.md$|^docs/|^\.github/)') || true
          if [ -n "$FILTERED" ] && ! echo "$CHANGED" | grep -q '^.changeset/'; then
            echo "\nERROR: This PR modifies source files but does not include a .changeset file.\n" >&2
            echo "Please run 'pnpm changeset' locally and add the generated file to the PR." >&2
            exit 1
          fi
